 /*
 * AutoSuggest
 * Copyright 2009-2010 Drew Wilson
 * www.drewwilson.com
 * code.drewwilson.com/entry/autosuggest-jquery-plugin
 *
 * Version 1.4.1   -   Updated: Sep. 14, 2014
 *
 * This Plug-In will auto-complete or auto-suggest completed search queries
 * for you as you type. You can add multiple selections and remove them on
 * the fly. It supports keybord navigation (UP + DOWN + RETURN), as well
 * as multiple AutoSuggest fields on the same page.
 *
 * Inspied by the Autocomplete plugin by: Jšrn Zaefferer
 * and the Facelist plugin by: Ian Tearle (iantearle.com)
 *
 * This AutoSuggest jQuery plug-in is dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */
 (function(b){function a(c){return c.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}b.fn.autoSuggest=function(g,l){var f={asHtmlID:false,startText:"Enter Name Here",emptyText:"No Results Found",preFill:{},limitText:"No More Selections Are Allowed",selectedItemProp:"value",selectedValuesProp:"value",searchObjProps:"value",queryParam:"q",retrieveLimit:false,extraParams:"",matchCase:false,minChars:1,keyDelay:400,resultsHighlight:true,neverSubmit:false,selectionLimit:false,showResultList:true,start:function(){},selectionClick:function(k){},selectionAdded:function(k){},selectionRemoved:function(k){k.remove()},formatList:false,beforeRetrieve:function(k){return k},retrieveComplete:function(k){return k},resultClick:function(k){},resultsComplete:function(){}};var c=b.extend(f,l);var d="object";var j=0;if(typeof g=="string"){d="string";var h=g}else{var i=g;for(var e in g){if(g.hasOwnProperty(e)){j++}}}if((d=="object"&&j>0)||d=="string"){return this.each(function(A){var n;if(!c.asHtmlID){A=A+""+Math.floor(Math.random()*100);n="as-input-"+A}else{A=c.asHtmlID;n=A}c.start.call(this);var C=b(this);C.attr("autocomplete","off").addClass("as-input").attr("id",n).val(c.startText);var G=false;C.wrap('<ul class="as-selections" id="as-selections-'+A+'"></ul>').wrap('<li class="as-original" id="as-original-'+A+'"></li>');var H=b("#as-selections-"+A);var w=b("#as-original-"+A);var p=b('<div class="as-results" id="as-results-'+A+'"></div>').hide();var q=b('<ul class="as-list"></ul>');var L=b('<input type="hidden" class="as-values" name="as_values_'+A+'" id="as-values-'+A+'" />');var v="";var J;if(typeof c.preFill=="string"){var D=c.preFill.split(",");for(J=0;J<D.length;J++){var o={};o[c.selectedValuesProp]=D[J];if(D[J]!==""){K(o,"000"+J)}}v=c.preFill}else{v="";var M=0;for(var I in c.preFill){if(c.preFill.hasOwnProperty(I)){M++}}if(M>0){for(J=0;J<M;J++){var E=c.preFill[J][c.selectedValuesProp];if(E===undefined){E=""}v=v+E+",";if(E!==""){K(c.preFill[J],"000"+J)}}}}if(v!==""){C.val("");var B=v.substring(v.length-1);if(B!=","){v=v+","}L.val(","+v).trigger("change");b("li.as-selection-item",H).addClass("blur").removeClass("selected")}C.after(L);H.click(function(){G=true;C.focus()}).mousedown(function(){G=false}).after(p);var z=null;var F="";var r=0;var s=false;C.focus(function(){if(b(this).val()==c.startText&&L.val()===""){b(this).val("")}else{if(G){b("li.as-selection-item",H).removeClass("blur");if(b(this).val()!==""){q.css("width",H.outerWidth());p.show()}}}G=true;return true}).blur(function(){if(b(this).val()===""&&L.val()===""&&v===""){b(this).val(c.startText)}else{if(G){b("li.as-selection-item",H).addClass("blur").removeClass("selected");p.hide()}}}).keydown(function(R){lastKeyPressCode=R.keyCode;first_focus=false;switch(R.keyCode){case 38:R.preventDefault();y("up");break;case 40:R.preventDefault();y("down");break;case 8:if(C.val()===""){var N=L.val().split(",");N=N[N.length-2];H.children().not(w.prev()).removeClass("selected");if(w.prev().hasClass("selected")){var x=new RegExp("(^|,)"+a(N)+"(,|$)");L.val(L.val().replace(x,",")).trigger("change");c.selectionRemoved.call(this,w.prev())}else{c.selectionClick.call(this,w.prev());w.prev().addClass("selected")}}if(C.val().length==1){p.hide();F=""}if(b(":visible",p).length>0){if(z){clearTimeout(z)}z=setTimeout(function(){m()},c.keyDelay)}break;case 9:case 188:s=true;var P=C.val().replace(/(,)/g,"").trim();if(P!==""&&L.val().search(new RegExp("(^|,)"+a(P)+"(,|$)"))<0&&P.length>=c.minChars){R.preventDefault();var O={};O[c.selectedItemProp]=P;O[c.selectedValuesProp]=P;var k=b("li",H).length;K(O,"00"+(k+1));C.val("")}break;case 13:s=false;var Q=b("li.active:first",p);if(Q.length>0){Q.click();p.hide()}if(c.neverSubmit||Q.length>0){R.preventDefault()}break;default:if(c.showResultList){if(c.selectionLimit&&b("li.as-selection-item",H).length>=c.selectionLimit){q.html('<li class="as-message">'+c.limitText+"</li>");p.show()}else{if(z){clearTimeout(z)}z=setTimeout(function(){m()},c.keyDelay)}}break}});function m(){if(lastKeyPressCode==46||(lastKeyPressCode>8&&lastKeyPressCode<32)){return p.hide()}var x=C.val().replace(/[\\]+|[\/]+/g,"");if(x==F){return}F=x;if(x.length>=c.minChars){H.addClass("loading");if(d=="string"){var k="";if(c.retrieveLimit){k="&limit="+encodeURIComponent(c.retrieveLimit)}if(c.beforeRetrieve){x=c.beforeRetrieve.call(this,x)}b.getJSON(h+"?"+c.queryParam+"="+encodeURIComponent(x)+k+c.extraParams,function(P){j=0;var N=c.retrieveComplete.call(this,P);for(var O in N){if(N.hasOwnProperty(O)){j++}}t(N,x)})}else{if(c.beforeRetrieve){x=c.beforeRetrieve.call(this,x)}t(i,x)}}else{H.removeClass("loading");p.hide()}}var u=0;function t(O,U){if(!c.matchCase){U=U.toLowerCase()}var W=0;p.html(q.html("")).hide();for(var P=0;P<j;P++){var Q=P;u++;var R=false;var S;if(c.searchObjProps=="value"){S=O[Q].value}else{S="";var T=c.searchObjProps.split(",");for(var V=0;V<T.length;V++){var k=b.trim(T[V]);S=S+O[Q][k]+" "}}if(S){if(!c.matchCase){S=S.toLowerCase()}if(S.search(a(U))!=-1&&L.val().search(a("(^|,)"+O[Q][c.selectedValuesProp]+"(,|$)"))==-1){R=true}}if(R){var N=b('<li class="as-result-item" id="as-result-item-'+Q+'"></li>').click(function(){var aa=b(this).data("data");var Y=aa.num;if(b("#as-selection-"+Y,H).length<=0&&!s){var Z=aa.attributes;C.val("").focus();F="";K(Z,Y);c.resultClick.call(this,aa);p.hide()}s=false}).mousedown(function(){G=false}).mouseover(function(){b("li",q).removeClass("active");b(this).addClass("active")}).data("data",{attributes:O[Q],num:u});var X=b.extend({},O[Q]);var x;if(!c.matchCase){x=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+a(U)+")(?![^<>]*>)(?![^&;]+;)","gi")}else{x=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+a(U)+")(?![^<>]*>)(?![^&;]+;)","g")}if(c.resultsHighlight){X[c.selectedItemProp]=X[c.selectedItemProp].replace(x,"<em>$1</em>")}if(!c.formatList){N=N.html(X[c.selectedItemProp])}else{N=c.formatList.call(this,X,N)}q.append(N);W++;if(c.retrieveLimit&&c.retrieveLimit==W){break}}}H.removeClass("loading");if(W<=0){q.html('<li class="as-message">'+c.emptyText+"</li>")}q.css("width",H.outerWidth());p.show();c.resultsComplete.call(this)}function K(N,k){L.val(L.val()+N[c.selectedValuesProp]+",").trigger("change");var x=b('<li class="as-selection-item" id="as-selection-'+k+'"></li>').click(function(){c.selectionClick.call(this,b(this));H.children().removeClass("selected");b(this).addClass("selected")}).mousedown(function(){G=false});var O=b('<a class="as-close">&times;</a>').click(function(){L.val(L.val().replace(N[c.selectedValuesProp]+",","")).trigger("change");c.selectionRemoved.call(this,x);G=true;C.focus();return false});w.before(x.html(N[c.selectedItemProp]).prepend(O));c.selectionAdded.call(this,w.prev())}function y(N){if(b(":visible",p).length>0){var k=b("li",p);var O;if(N=="down"){O=k.eq(0)}else{O=k.filter(":last")}var x=b("li.active:first",p);if(x.length>0){if(N=="down"){O=x.next()}else{O=x.prev()}}k.removeClass("active");O.addClass("active")}}})}}})(jQuery);